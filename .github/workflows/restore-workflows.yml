name: Restore Workflows if Missing

on:
  push:
    branches:
      - main

jobs:
  restore:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Check if workflows exist
        id: check
        run: |
          if [ ! -d ".github/workflows" ] || [ -z "$(ls -A .github/workflows 2>/dev/null | grep -v restore-workflows.yml)" ]; then
            echo "missing=true" >> $GITHUB_OUTPUT
          else
            echo "missing=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Restore workflows from backup branch
        if: steps.check.outputs.missing == 'true'
        run: |
          git fetch origin workflow-backup
          git checkout origin/workflow-backup -- .github/workflows
          git restore --staged .github/workflows/restore-workflows.yml
          git checkout .github/workflows/restore-workflows.yml
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git config user.name "github-actions[bot]"
          git add .github/workflows
          git commit -m "Auto-restore workflow files from backup"
          git push
