name: Deploy to Azure Blob Storage

# Controls when the workflow will run
on:
  # Runs on pushes to the main branch
  push:
    branches:
      - main
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      # Step 1: Checks out your repository code
      - name: Checkout Repository
        uses: actions/checkout@v3

      # Step 2: Set up Node.js and build the static website
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18' # Adjust version as needed (e.g., '20')
          
      - name: Install Dependencies
        run: npm install

      - name: Build Static Files
        # This command creates the 'dist' folder which contains your website
        run: npm run build 

      # Step 3: Upload the built files to Azure Blob Storage
      - name: Upload to Azure Blob Storage
        run: |
          # Install Azure CLI tool used for the upload
          curl -sL https://aka.ms/InstallAzureCLIDeb | bash
          
          # Define variables for the deployment
          STORAGE_ACCOUNT="brahmastrakids1"
          SOURCE_FOLDER="dist"
          CONTAINER_NAME='$web' # The default container for static websites

          echo "Uploading files from $SOURCE_FOLDER to $CONTAINER_NAME container in $STORAGE_ACCOUNT"
          
          # Check if the build folder exists before uploading
          if [ -d "$SOURCE_FOLDER" ]; then
            az storage blob upload-batch \
              --account-name $STORAGE_ACCOUNT \
              --container-name $CONTAINER_NAME \
              --source $SOURCE_FOLDER \
              --connection-string "${{ secrets.AZURE_BLOB_STORAGE_CONNECTION_STRING }}"
          else
            echo "Error: The build folder '$SOURCE_FOLDER' was not found. Check 'npm run build' output."
            exit 1
          fi
          
          echo "Files uploaded to Azure Blob Storage successfully!"

      # Optional: Verify upload by listing files
      - name: Verify Upload
        run: |
          curl -sL https://aka.ms/InstallAzureCLIDeb | bash
          
          echo "Listing files in $CONTAINER_NAME container:"
          
          az storage blob list \
            --account-name brahmastrakids1 \
            --container-name '$web' \
            --connection-string "${{ secrets.AZURE_BLOB_STORAGE_CONNECTION_STRING }}" \
            --output table
