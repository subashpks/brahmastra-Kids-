name: Deploy to Azure Blob Storage

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      # Step 1: Build the Static Website
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          
      - name: Install Dependencies
        run: npm install

      - name: Build Static Files (Creates 'dist' folder)
        run: npm run build
        
      # --- DIAGNOSTIC STEP ---
      # This step checks if the 'dist' folder was created and what's inside it.
      - name: Check Build Output Directory
        run: |
          echo "Listing contents of the GitHub workspace after build:"
          ls -R 
          
          if [ -d "dist" ]; then
            echo "SUCCESS: 'dist' folder FOUND."
          else
            echo "FAILURE: 'dist' folder NOT FOUND. Check the 'Build Static Files' step logs for errors."
            exit 1
          fi
      # -----------------------

      # Step 2: Upload the built files to Azure Blob Storage
      - name: Upload to Azure Blob Storage
        uses: azure/cli@v1
        with:
          # CRITICAL: Ensures the CLI container sees the files
          working-directory: ${{ github.workspace }}
          inlineScript: |
            STORAGE_ACCOUNT="brahmastrakids1"
            # Using an absolute path ensures the container knows exactly where to look
            SOURCE_FOLDER="${{ github.workspace }}/dist" 
            CONTAINER_NAME='$web' 
            CONNECTION_STRING="${{ secrets.AZURE_BLOB_STORAGE_CONNECTION_STRING }}"
            
            echo "Starting upload from absolute path: $SOURCE_FOLDER to $CONTAINER_NAME container."
            
            if [ -d "$SOURCE_FOLDER" ]; then
              az storage blob upload-batch \
                --account-name $STORAGE_ACCOUNT \
                --destination $CONTAINER_NAME \
                --source "$SOURCE_FOLDER" \ # SOURCE_FOLDER is now an absolute path
                --connection-string "$CONNECTION_STRING" \
                --overwrite true
            else
              echo "Error: The build folder '$SOURCE_FOLDER' was not found during upload."
              exit 1
            fi
            
            echo "Files uploaded to Azure Blob Storage successfully!"

      # Step 3: Verify upload by listing files
      - name: Verify Upload
        uses: azure/cli@v1
        with:
          working-directory: ${{ github.workspace }}
          inlineScript: |
            echo "Verifying uploaded files:"
            az storage blob list \
              --account-name brahmastrakids1 \
              --container-name '$web' \
              --connection-string "${{ secrets.AZURE_BLOB_STORAGE_CONNECTION_STRING }}" \
              --output table
