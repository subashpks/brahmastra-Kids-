name: Deploy to Azure Blob Storage

on:
  # Runs automatically whenever code is pushed to the 'main' branch
  push:
    branches:
      - main
  # Allows manual running from the 'Actions' tab in GitHub
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      # Step 1: Checkout the repository code
      - name: Checkout Repository
        uses: actions/checkout@v4

      # Step 2: Set up Node.js environment and build the React app
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18' # Adjust if your project requires a different version
          
      - name: Install Dependencies
        run: npm install

      - name: Build Static Files (React App)
        # Confirmed: This command creates the 'dist' folder
        run: npm run build 

      # Step 3: Upload the built files to Azure Blob Storage
      - name: Upload to Azure Blob Storage
        uses: azure/cli@v1
        with:
          # CRITICAL FIX: Ensures the 'dist' folder is visible to the Azure CLI container
          working-directory: ${{ github.workspace }}
          inlineScript: |
            STORAGE_ACCOUNT="brahmastrakids1"
            SOURCE_FOLDER="dist"
            CONTAINER_NAME='$web' # The default container for static websites
            CONNECTION_STRING="${{ secrets.AZURE_BLOB_STORAGE_CONNECTION_STRING }}"
            
            echo "Starting upload of files from /$SOURCE_FOLDER to $CONTAINER_NAME container."
            
            if [ -d "$SOURCE_FOLDER" ]; then
              az storage blob upload-batch \
                --account-name $STORAGE_ACCOUNT \
                --destination $CONTAINER_NAME \  # FIX: Correctly uses --destination flag
                --source $SOURCE_FOLDER \
                --connection-string "$CONNECTION_STRING" \
                --overwrite true
            else
              echo "Error: The build folder '$SOURCE_FOLDER' was not found. Deployment failed."
              exit 1
            fi
            
            echo "Files uploaded to Azure Blob Storage successfully!"

      # Optional Step 4: Verify upload by listing files
      - name: Verify Upload
        uses: azure/cli@v1
        with:
          working-directory: ${{ github.workspace }}
          inlineScript: |
            echo "Verifying uploaded files:"
            az storage blob list \
              --account-name brahmastrakids1 \
              --container-name '$web' \
              --connection-string "${{ secrets.AZURE_BLOB_STORAGE_CONNECTION_STRING }}" \
              --output table
